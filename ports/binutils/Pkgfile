# Description: linker, assembler and other development tools
name=binutils
version=2.38
release=mix-1
source=(https://ftp.gnu.org/gnu/binutils/binutils-$version.tar.xz
	https://www.linuxfromscratch.org/patches/lfs/development/binutils-2.38-lto_fix-1.patch
)

build() {
  cd $name-$version

  # upstream patch
  patch -Np1 -i ../binutils-2.38-lto_fix-1.patch

  # upstream fix
  sed -e '/R_386_TLS_LE /i \   || (TYPE) == R_386_TLS_IE \\' \
    -i ./bfd/elfxx-x86.h

  mkdir -v build
  cd build

  ../configure --prefix=/usr \
    --enable-gold \
    --enable-ld=default \
    --enable-plugins \
    --enable-shared \
    --disable-werror \
    --enable-64-bit-bfd \
    --with-system-zlib
  make tooldir=/usr
  $TST make -k check || true
  make tooldir=/usr DESTDIR=$PKG install -j1
  rm -fv $PKG/usr/lib/lib{bfd,ctf,ctf-nobfd,opcodes}.a
  rm -rv $PKG/usr/share/info
}
