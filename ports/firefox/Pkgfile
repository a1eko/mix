# Description: Mozilla web browser
# Depends on: autoconf-2.13 cbindgen dbus-glib gtk gtk3 libnotify llvm lld clang nasm nodejs nss alsa-lib python3 startup-notification unzip yasm zip

name=firefox
version=102.3.0
release=mix-1
source=(https://archive.mozilla.org/pub/firefox/releases/${version}esr/source/firefox-${version}esr.source.tar.xz
	mozconfig)

build() {
  cd $name-$version

  cp -v $SRC/mozconfig .

  # fix cbindgen interaction
  sed -i '/ROOT_CLIP_CHAIN/d' gfx/webrender_bindings/webrender_ffi.h

  export CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib
  export MOZBUILD_STATE_PATH=${PWD}/mozbuild
  export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system
  export MOZ_NOSPAM=1

  ./mach configure
  ./mach build
  DESTDIR=$PKG ./mach install

  install -d $PKG/usr/share/pixmaps
  ln -sv /usr/lib/firefox/browser/chrome/icons/default/default48.png $PKG/usr/share/pixmaps/firefox_default48.png

  rm -rv $PKG/usr/lib/firefox/browser/features
  rm -v $PKG/usr/lib/firefox/removed-files
}
