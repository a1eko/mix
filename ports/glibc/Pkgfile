# Description: system C library

name=glibc
version=2.32
release=mix-1
source=(ftp://ftp.gnu.org/gnu/glibc/glibc-$version.tar.xz
	http://www.linuxfromscratch.org/patches/downloads/glibc/glibc-$version-fhs-1.patch
	host.conf hosts ld.so.conf nsswitch.conf resolv.conf)

build()
{
  cd $name-$version
  patch -Np1 -i ../glibc-$version-fhs-1.patch

  mkdir -v build
  cd build

  ../configure --prefix=/usr \
    --disable-werror \
    --enable-kernel=3.2 \
    --enable-stack-protector=strong \
    --with-headers=/usr/include \
    libc_cv_slibdir=/lib
  make

  # create links for running tests (to be overwritten by forced install)
  case $(uname -m) in
    i?86) ln -sfnv $PWD/elf/ld-linux.so.2 /lib ;;
    x86_64) ln -sfnv $PWD/elf/ld-linux-x86-64.so.2 /lib ;;
  esac

  $TST TIMEOUTFACTOR=16 make -k check || true
  install -Dv -m 644 $SRC/ld.so.conf $PKG/etc/ld.so.conf

  # skip unneded sanity check
  sed '/test-installation/s@$(PERL)@echo not running@' -i ../Makefile

  make install_root=$PKG install
  rm -rv $PKG/usr/share/info
  find $PKG -name "*install.cmd" -delete
  find $PKG -name ".\install" -delete

  # install nscd
  cp -v ../nscd/nscd.conf $PKG/etc/nscd.conf
  mkdir -pv $PKG/var/cache/nscd

  # install locales (optional)
  #make install_root=$PKG localedata/install-locales

  # install configuration files
  install -v -m 644 $SRC/nsswitch.conf $PKG/etc/nsswitch.conf
  install -v -m 644 $SRC/hosts $PKG/etc/hosts
  install -v -m 644 $SRC/host.conf $PKG/etc/host.conf
  install -v -m 644 $SRC/resolv.conf $PKG/etc/resolv.conf
  mkdir -v $PKG/etc/ld.so.conf.d

  # conflicts with tzdata
  rm -v $PKG/usr/bin/tzselect
  rm -v $PKG/usr/sbin/{zdump,zic}
}
