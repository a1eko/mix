# Description: system C library

name=glibc
version=2.26
release=mix-1
source=(ftp://ftp.gnu.org/gnu/glibc/glibc-$version.tar.xz
	http://www.linuxfromscratch.org/patches/downloads/glibc/glibc-$version-fhs-1.patch
	host.conf hosts ld.so.conf nsswitch.conf resolv.conf)

build()
{
  cd $name-$version
  patch -Np1 -i ../glibc-$version-fhs-1.patch

  # create compatibility links
  ln -sfv /tools/lib/gcc /usr/lib
  case $(uname -m) in
    i?86) GCC_INCDIR=/usr/lib/gcc/$(uname -m)-pc-linux-gnu/7.1.0/include
      ln -s ld-linux.so.2 /lib/ld-lsb.so.3
      ;;
    x86_64) GCC_INCDIR=/usr/lib/gcc/x86_64-pc-linux-gnu/7.1.0/include
      ln -s ../lib/ld-linux-x86-64.so.2 /lib64
      ln -s ../lib/ld-linux-x86-64.so.2 /lib64/ld-lsb-x86-64.so.3
      ;;
  esac

  # remove possible leftover
  rm -f /usr/include/limits.h

  mkdir -v build
  cd build

  CC="gcc -isystem $GCC_INCDIR -isystem /usr/include" \
  ../configure --prefix=/usr \
    --disable-werror \
    --enable-kernel=3.2 \
    --enable-obsolete-rpc \
    --enable-stack-protector=strong \
    libc_cv_slibdir=/lib
  make
  $TST TIMEOUTFACTOR=16 make -k check || true
  install -Dv -m 644 $SRC/ld.so.conf $PKG/etc/ld.so.conf

  # skip unneded sanity check
  sed '/test-installation/s@$(PERL)@echo not running@' -i ../Makefile

  make install_root=$PKG install
  rm -v $PKG/usr/include/rpcsvc/*.x
  rm -rv $PKG/usr/share/info

  # install nscd
  cp -v ../nscd/nscd.conf $PKG/etc/nscd.conf
  mkdir -pv $PKG/var/cache/nscd

  # install locales (optional)
  #make install_root=$PKG localedata/install-locales

  # install configuration files
  install -v -m 644 $SRC/nsswitch.conf $PKG/etc/nsswitch.conf
  install -v -m 644 $SRC/hosts $PKG/etc/hosts
  install -v -m 644 $SRC/host.conf $PKG/etc/host.conf
  install -v -m 644 $SRC/resolv.conf $PKG/etc/resolv.conf
  mkdir -v $PKG/etc/ld.so.conf.d

  # conflicts with tzdata
  rm -v $PKG/usr/bin/tzselect
  rm -v $PKG/usr/sbin/{zdump,zic}

  for file in nsswitch.conf ld.so.conf hosts host.conf resolv.conf; do
    mv -v $PKG/etc/$file{,.new}
  done
}
