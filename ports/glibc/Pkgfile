# Description: system C library

name=glibc
version=2.21
release=mix-1
source=(ftp://ftp.gnu.org/gnu/glibc/glibc-$version.tar.xz
	http://www.linuxfromscratch.org/patches/downloads/glibc/glibc-$version-fhs-1.patch
	host.conf hosts ld.so.conf nsswitch.conf resolv.conf)

build()
{
  cd $name-$version
  patch -Np1 -i ../glibc-$version-fhs-1.patch

  mkdir -v ../glibc-build
  cd ../glibc-build

  ../glibc-$version/configure --prefix=/usr \
    --disable-profile --enable-kernel=2.6.32 --enable-obsolete-rpc
  make
  $TST TIMEOUTFACTOR=16 make -k check || true
  install -Dv -m 644 ../ld.so.conf $PKG/etc/ld.so.conf
  make install_root=$PKG install
  rm -v $PKG/usr/include/rpcsvc/*.x
  rm -rv $PKG/usr/share/info

  # install nscd
  cp -v ../glibc-$version/nscd/nscd.conf $PKG/etc/nscd.conf
  mkdir -pv $PKG/var/cache/nscd

  # install locales (optional)
  #make install_root=$PKG localedata/install-locales

  # install configuration files
  install -v -m 644 ../nsswitch.conf $PKG/etc/nsswitch.conf
  install -v -m 644 ../hosts $PKG/etc/hosts
  install -v -m 644 ../host.conf $PKG/etc/host.conf
  install -v -m 644 ../resolv.conf $PKG/etc/resolv.conf
  mkdir -v $PKG/etc/ld.so.conf.d

  # conflicts with tzdata
  rm -v $PKG/usr/bin/tzselect
  rm -v $PKG/usr/sbin/{zdump,zic}

  for file in nsswitch.conf ld.so.conf hosts host.conf resolv.conf; do
    mv -v $PKG/etc/$file{,.new}
  done
}
