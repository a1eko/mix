#!/bin/bash
#
# /etc/rc - system boot script
#

echo "system is coming up ..."

# load configuration
. /etc/rc.conf

# mount virtual filesytems
/bin/mount /run
/bin/mkdir -p /run/{var,lock,shm}
/bin/chmod 1777 /run/shm /run/lock
/bin/mount /proc
/bin/mount /sys
/bin/mount /dev
ln -sfn /run/shm /dev/shm
/bin/mkdir -p /dev/pts
/bin/mount /dev/pts

# start udev
if [ -x /etc/init.d/udev ]; then
  /etc/init.d/udev start
  sleep 1
fi

# mount root read-only
/bin/mount -o remount,ro /

# check filesystems
if [ -f /forcefsck ]; then
  FORCEFSCK="-f"
fi
/sbin/fsck $FORCEFSCK -A -T -C -a
if [ $? -gt 1 ]; then
    echo "error ($?): filesystem check failed"
    /sbin/sulogin -p
    echo "automatic reboot in progress ..."
    /bin/umount -a -r
    /bin/mount -n -o remount,ro /
    /sbin/reboot -f
    exit 0
fi

# mount local filesystems
/bin/mount -o remount,rw /
/bin/mount -a -O no_netdev

# activate swap
/sbin/swapon -a

# clean up misc files
: > /var/run/utmp
/bin/rm -rf /forcefsck /fastboot /etc/nologin /etc/shutdownpid
(cd /var/run && /bin/find . -name "*.pid" -delete)
(cd /var/lock && /bin/find . ! -type d -delete)
(cd /tmp && /bin/find . ! -name . -delete)
/bin/mkdir -m 1777 /tmp/.ICE-unix

# set kernel variables
/sbin/sysctl -p > /dev/null

# update shared library links
/sbin/ldconfig

# configure host name
if [ "$HOSTNAME" ]; then
    echo "hostname: $HOSTNAME"
    /bin/hostname $HOSTNAME
fi

# load random seed
/bin/cat /var/lib/urandom/seed > /dev/urandom

# configure system clock
if [ "$TIMEZONE" ]; then
    echo "timezone: $TIMEZONE"
    /bin/ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
fi
/sbin/hwclock --hctosys

# start log daemons
/sbin/syslogd
/sbin/klogd -c 4

# load console font
if [ "$FONT" ]; then
    echo "font: $FONT"
    /bin/setfont $FONT
fi

# load console keymap
if [ "$KEYMAP" ]; then
    echo "keyboard: $KEYMAP"
    /bin/loadkeys -q $KEYMAP
fi

# screen blanks after 15 minutes idle time
/usr/bin/setterm -blank 15

# run module initialization script
if [ -x /etc/rc.modules ]; then
    /etc/rc.modules
fi

# save boot messages
/bin/dmesg > /var/log/boot

# End of file
